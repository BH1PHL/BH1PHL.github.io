<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta
    name="description"
    content=""
  />
  
  
    
      <title>关于 My4TH 的一些试验（四）：一些外设 | BH1PHL 的 Blog</title>
    
  
  <link rel="stylesheet" href="/css/reset.css"/>
  <link rel="stylesheet" href="/css/font.css"/>
  <link rel="stylesheet" href="/css/smigle.css"/>
  <link rel="stylesheet" href="/css/syntax.css"/>
  <link rel="stylesheet" href="/css/codecolor.css"/>
  <link rel="stylesheet" href="/css/styles.css"/>
  
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="site.webmanifest">
  <link rel="mask-icon" href="android-chrome-512x512.png" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
</head>

  <body>
    <div id="root">
      <header>
  <div id="brand">
    <a class="icon-link" href="/zh/">
      
        <img
          class="icon"
          src="/images/china_ar.svg"
        />
      
    </a>
    <div class="text">
      <a href="/zh/"><h1>BH1PHL 的 Blog</h1></a>
      
    </div>
  </div>
  <nav>
    
      
        
        <a href="/zh/"><b>Home</b></a>
      
         | 
        <a href="/zh/about"><b>About</b></a>
      
         | 
        <a href="/zh/posts"><b>Posts</b></a>
      
         | 
        <a href="/zh/tags"><b>Tags</b></a>
      
         | 
        <a href="/zh/index.xml"><b>RSS</b></a>
      
    
    |
    
      
        <a href="/posts/my4th_peripherals/"><b>English</b></a>
      
    
  </nav>
  <hr />
</header>

      <div id="content">
        
  <main>
    <article>
      <h1 class="title">关于 My4TH 的一些试验（四）：一些外设</h1>
      
      <div class="post-meta">
  <strong>
    <span>Posted on</span>
    <time>2025-02-18</time>
    
    
  </strong>
  <span> • 746 words</span>
  <span> • 2 minute read</span>
  
  
    <div>
      <span>Tags:</span>
      
        <a href="/zh/tags/my4th">My4TH</a>, 
        <a href="/zh/tags/forth">Forth</a>
    </div>
  
</div>

      <div class="content"><h2 id="存储扩展卡与底板">存储扩展卡与底板</h2>
<h3 id="存储扩展卡">存储扩展卡</h3>
<p>为方便使用外接的 EEPROM 存储扩展卡，<a href="https://bh1phl.github.io/zh/posts/my4th_faster/">本站提供的固件</a>中，相邻的块位于同一片 EEPROM 上，且块序号按 EEPROM 地址排列。</p>
<p>外接存储扩展卡使用 USB 3.0 Type-A 接口，电源触点与标准 USB 接口兼容，信号触点用于 I2C 接口和寻址等：</p>
<p><img src="/a/my4th_peripherals/eeprom-card-interface.png" alt="EEPROM Card Interface"></p>
<p>其中 <code>SOCKET</code> 连接 EEPROM 的地址线 <code>A1</code>：</p>
<p><img src="/a/my4th_peripherals/eeprom-card-eeprom.png" alt="EEPROM on Card"></p>
<p>存储扩展卡的 KiCad 工程文件在<a href="/s/my4th/eeprom-card-128k.7z">这里</a>下载。</p>
<p><img src="/a/my4th_peripherals/eeprom-card.jpg" alt="EEPROM Card"></p>
<h3 id="底板">底板</h3>
<p>用于连接存储扩展卡、提供 5.2V/5.4V 电源（用于工作在 20MHz 和 22.1184MHz）的底板的 KiCad 工程文件在<a href="/s/my4th/my4th-backplane-v1.2.7z">这里</a>下载。底板上还提供了 DS1307 实时时钟和 PCA9557 I/O 扩展。</p>
<p><img src="/a/my4th_peripherals/backplane_naked.jpg" alt="Backplane"></p>
<p><img src="/a/my4th_peripherals/backplane_combined.jpg" alt="Backplane with My4TH SMT"></p>
<p>My4TH SMT 和底板的连接器选用通用的 0.8mm 间距 2x16 双槽板对板连接器（合高 4mm，例如<a href="https://item.szlcsc.com/43259289.html">这个</a>和<a href="https://item.szlcsc.com/43259310.html">这个</a>，或者<a href="https://item.taobao.com/item.htm?id=592117990571&amp;skuId=4385836045812">这个</a>。My4TH 板上用母座，底板上用公座）。总线连接器选用 PHB 2x20 型弯插座。</p>
<p>电源部分电路如下图。SW1 和 SW2 选用外形尺寸 6.6x2.7mm，脚距 1.5mm 的 7 脚拨动开关（例如<a href="https://item.szlcsc.com/778254.html">这个</a>）。</p>
<p><img src="/a/my4th_peripherals/backplane-power.png" alt="Backplane Power"></p>
<h4 id="ds1307-和-pca9557-驱动">DS1307 和 PCA9557 驱动</h4>
<p>底板上的 DS1307 实时时钟占用 I2C 地址 $D0。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-forth" data-lang="forth"><span class="line"><span class="cl"><span class="c1">\ C DS1307 Driver
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kn">:</span> <span class="nc">dec2bcd</span> <span class="c1">( dec -- bcd )</span> <span class="mi">10</span> <span class="k">/mod </span><span class="mi">16</span> <span class="k">* + ; </span><span class="c1">\ 2 digits only
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kn">:</span> <span class="nc">bcd2dec</span> <span class="c1">( bcd -- dec )</span> <span class="mi">16</span> <span class="k">/mod </span><span class="mi">10</span> <span class="k">* + ;
</span></span></span><span class="line"><span class="cl"><span class="k"></span><span class="kn">:</span> <span class="nc">rtc-rh</span>  <span class="mh">$d0</span> <span class="nf">i2c-rr</span> <span class="k">drop ; </span>  <span class="kn">:</span> <span class="nc">rtc-wh</span>  <span class="mh">$d0</span> <span class="nf">i2c-wr</span> <span class="k">drop ;
</span></span></span><span class="line"><span class="cl"><span class="k"></span><span class="c1">\ 0:sec(use rtc-sc@/!) 1:min 2:hour 3:day 4:date 5:month 6:year
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kn">:</span> <span class="nc">rtc-r</span> <span class="c1">( reg -- dat )</span> <span class="nf">rtc-rh</span> <span class="nf">bcd2dec</span> <span class="k">;
</span></span></span><span class="line"><span class="cl"><span class="k"></span><span class="kn">:</span> <span class="nc">rtc-w</span> <span class="c1">( dat reg -- )</span> <span class="k">swap </span><span class="nf">dec2bcd</span> <span class="k">swap </span><span class="nf">rtc-wh</span> <span class="k">;
</span></span></span><span class="line"><span class="cl"><span class="k"></span><span class="kn">:</span> <span class="nc">rtc-sc@</span>  <span class="mi">0</span> <span class="nf">rtc-rh</span> <span class="mi">127</span> <span class="k">and </span><span class="nf">bcd2dec</span> <span class="k">;
</span></span></span><span class="line"><span class="cl"><span class="k"></span><span class="kn">:</span> <span class="nc">rtc-sc!</span>  <span class="nf">dec2bcd</span> <span class="mi">0</span> <span class="nf">rtc-rh</span> <span class="mi">128</span> <span class="k">and or </span><span class="mi">0</span> <span class="nf">rtc-wh</span> <span class="k">;
</span></span></span><span class="line"><span class="cl"><span class="k"></span><span class="kn">:</span> <span class="nc">rtc-stop</span>  <span class="mi">0</span> <span class="nf">rtc-rh</span> <span class="mi">128</span> <span class="k">or </span><span class="mi">0</span> <span class="nf">rtc-wh</span> <span class="k">;
</span></span></span><span class="line"><span class="cl"><span class="k"></span><span class="kn">:</span> <span class="nc">rtc-start</span>  <span class="mi">0</span> <span class="nf">rtc-rh</span> <span class="mi">127</span> <span class="k">and </span><span class="mi">0</span> <span class="nf">rtc-wh</span> <span class="k">;
</span></span></span><span class="line"><span class="cl"><span class="k"></span><span class="c1">\ Forth 2012 Facility Extension word TIME&amp;DATE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kn">:</span> <span class="nc">time&amp;date</span> <span class="c1">( -- sec min hour date month year )</span>
</span></span><span class="line"><span class="cl">   <span class="nf">rtc-sc@</span> <span class="mi">1</span> <span class="nf">rtc-r</span> <span class="mi">2</span> <span class="nf">rtc-r</span> <span class="mi">4</span> <span class="nf">rtc-r</span> <span class="mi">5</span> <span class="nf">rtc-r</span> <span class="mi">6</span> <span class="nf">rtc-r</span> <span class="mi">2000</span> <span class="k">+ ;
</span></span></span></code></pre></div><p>使用下面的驱动时，<code>addr</code> 为底板上 PCA9557 I/O 扩展器的 I2C 地址 $34。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-forth" data-lang="forth"><span class="line"><span class="cl"><span class="c1">\ C I2C PCA9557 Driver
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kn">:</span> <span class="nc">p57-pc</span> <span class="c1">( addr -- )</span> <span class="mh">$00</span> <span class="mh">$02</span> <span class="k">rot </span><span class="nf">i2c-wr</span> <span class="k">drop ; </span><span class="c1">\ polarity clear
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kn">:</span> <span class="nc">p57-dir</span> <span class="c1">( dir addr -- )</span> <span class="k">swap </span><span class="mh">$03</span> <span class="k">rot </span><span class="nf">i2c-wr</span> <span class="k">drop ;
</span></span></span><span class="line"><span class="cl"><span class="k"></span><span class="kn">:</span> <span class="nc">p57-wo</span> <span class="c1">( val addr -- )</span> <span class="k">swap </span><span class="mh">$01</span> <span class="k">rot </span><span class="nf">i2c-wr</span> <span class="k">drop ;
</span></span></span><span class="line"><span class="cl"><span class="k"></span><span class="kn">:</span> <span class="nc">p57-ro</span> <span class="c1">( addr -- val )</span> <span class="mh">$01</span> <span class="k">swap </span><span class="nf">i2c-rr</span> <span class="k">drop ;
</span></span></span><span class="line"><span class="cl"><span class="k"></span><span class="kn">:</span> <span class="nc">p57-ri</span> <span class="c1">( addr -- val )</span> <span class="mh">$00</span> <span class="k">swap </span><span class="nf">i2c-rr</span> <span class="k">drop ;
</span></span></span></code></pre></div><h3 id="eprom-锁紧座">EPROM 锁紧座</h3>
<p>使用锁紧座可以方便地测试不同的 EPROM。锁紧座和 My4TH SMT 板之间采用 6mm 的弹簧顶针（例如<a href="https://item.szlcsc.com/5795476.html">这个</a>和<a href="https://item.taobao.com/item.htm?id=750082995689&amp;skuId=5172933449509">这个</a>）连接。 KiCad 工程文件在<a href="/s/my4th/my4th_smt_eprom_test_fixture.7z">这里</a>下载。</p>
<p><img src="/a/my4th_peripherals/test-fixture.jpg" alt="EPROM ZIF Socket"></p>
<h2 id="1602-液晶屏与按键">1602 液晶屏与按键</h2>
<p>借助 PCA9557 I/O 扩展器和 74HC165 移位寄存器，可以用 I2C 接口驱动 1602 液晶屏与按键：</p>
<p><img src="/a/my4th_peripherals/i2c-lcd-sch.png" alt="I2C LCD and Button"></p>
<p><a href="/s/my4th/i2c-clock.scr">这</a>是一个时钟的例子，其中用到了 1602 液晶屏、按键，以及 DS1307 实时时钟。KiCad 工程文件在<a href="/s/my4th/my4th-i2c-lcd-v1.3.7z">这里</a>下载。</p>
<p><img src="/a/my4th_peripherals/i2c-lcd.jpg" alt="I2C Clock"></p>
</div>
    </article>
  </main>

      </div>
      <footer>
  <hr />
  
    <p id="social">
      Find me around the web:
      <br />
      
        
        <a href="mailto:bh1phl%20[at]%20hotmail.com">email</a>
      
         | 
        <a href="http://www.qrz.com/db/BH1PHL">qrz.com</a>
      
         | 
        <a href="https://qsl.net/bh1phl">qsl.net</a>
      
         | 
        <a href="https://bh1phl.github.io">github.io</a>
      
    </p>
  
  <p class="copyright">
    Copyright © 2014-2025
    <a href="/zh/"><strong>BH1PHL</strong></a>.
    Licensed under the
    <a href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> license unless otherwise noted.
  </p>
  <p class="builtWith">
    Built with
    <a href="http://www.gohugo.io/">Hugo</a>,
    using the theme
    <a href="https://gitlab.com/ian-s-mcb/smigle-hugo-theme">smigle</a>,
    which was influenced by the theme
    <a href="https://github.com/sumnerevans/smol">smol</a>.
  </p>
  <script>
    
    if (window.location.host !== 'qsl.net')
        window.goatcounter = {no_onload: true}
  </script>
  <script data-goatcounter="https://bh1phl.goatcounter.com/count"
    async src="https://qsl.net/bh1phl/count.js"></script>
</footer>

    </div>
  </body>
</html>
