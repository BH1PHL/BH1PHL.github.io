<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta
    name="description"
    content=""
  />
  
  
    
      <title>在 RP2040 的多核模式下使用 littlefs 文件系统 | BH1PHL 的 Blog</title>
    
  
  <link rel="stylesheet" href="/css/reset.css"/>
  <link rel="stylesheet" href="/css/font.css"/>
  <link rel="stylesheet" href="/css/smigle.css"/>
  <link rel="stylesheet" href="/css/syntax.css"/>
  <link rel="stylesheet" href="/css/codecolor.css"/>
  <link rel="stylesheet" href="/css/styles.css"/>
  
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="site.webmanifest">
  <link rel="mask-icon" href="android-chrome-512x512.png" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
</head>

  <body>
    <div id="root">
      <header>
  <div id="brand">
    <a class="icon-link" href="/zh/">
      
        <img
          class="icon"
          src="/images/china_ar.svg"
        />
      
    </a>
    <div class="text">
      <a href="/zh/"><h1>BH1PHL 的 Blog</h1></a>
      
    </div>
  </div>
  <nav>
    
      
        
        <a href="/zh/"><b>Home</b></a>
      
         | 
        <a href="/zh/about"><b>About</b></a>
      
         | 
        <a href="/zh/posts"><b>Posts</b></a>
      
         | 
        <a href="/zh/tags"><b>Tags</b></a>
      
         | 
        <a href="/zh/index.xml"><b>RSS</b></a>
      
    
    |
    
      
        <a href="/posts/rp2040_multicore_littlefs/"><b>English</b></a>
      
    
  </nav>
  <hr />
</header>

      <div id="content">
        
  <main>
    <article>
      <h1 class="title">在 RP2040 的多核模式下使用 littlefs 文件系统</h1>
      
      <div class="post-meta">
  <strong>
    <span>Posted on</span>
    <time>2025-10-26</time>
    
    
  </strong>
  <span> • 479 words</span>
  <span> • 1 minute read</span>
  
  
    <div>
      <span>Tags:</span>
      
        <a href="/zh/tags/%E7%9F%A5%E8%AF%86%E5%BA%93">知识库</a>, 
        <a href="/zh/tags/rp2040">RP2040</a>, 
        <a href="/zh/tags/littlefs">littlefs</a>
    </div>
  
</div>

      <div class="content"><p>RP2040 的程序存储在 SPI Flash 中，运行时会随机读取 Flash 中的程序到内部的高速缓存以便执行。这在单核工作时并不构成问题，但是在多核模式下，如果一个核在执行程序，另一个核在写 Flash（例如使用 <a href="https://github.com/littlefs-project/littlefs">littlefs</a> 文件系统管理 SPI Flash 中不存储程序的剩余空间），则有可能造成同时读写 Flash 的状况，导致一个或两个核上的程序停止运行。</p>
<p>在常见的场景下，写 Flash 只发生在一个核上。例如核 0 （默认启动的核）处理用户界面等复杂操作，核 1 作为数字信号处理器使用，只处理信号链相关的业务。这种情况下，可以通过下面的方法简单地解决这一问题。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;pico/multicore.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;hardware/irq.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">volatile</span> <span class="kt">int</span> <span class="n">Pause_core1</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">volatile</span> <span class="kt">int</span> <span class="n">Core1_paused</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="c1">//set as &#34;paused&#34; initially (before core 1 starts)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">core1_process</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">	    <span class="c1">// ... Signal processing codes ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	    <span class="c1">// ...............................
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	    <span class="c1">// ...............................
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	    <span class="k">if</span> <span class="p">(</span><span class="n">Pause_core1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">	        <span class="kt">int</span> <span class="n">s</span><span class="o">=</span><span class="nf">save_and_disable_interrupts</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	        <span class="n">Core1_paused</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	        <span class="k">while</span><span class="p">(</span><span class="n">Pause_core1</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">	            <span class="nf">tight_loop_contents</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	        <span class="p">}</span>
</span></span><span class="line"><span class="cl">	        <span class="c1">// Necessary re-init codes for resume processing here
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	        <span class="c1">// .........
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	        <span class="c1">// .........
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	        <span class="nf">restore_interrupts_from_disabled</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	        <span class="n">Core1_paused</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//call from core0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">core1_launch</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">	<span class="n">Core1_paused</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">multicore_launch_core1</span><span class="p">(</span><span class="n">core1_process</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">core1_stop</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">Pause_core1</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>   <span class="c1">//pause core1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">Core1_paused</span><span class="p">){</span>    <span class="c1">//wait until core1 paused
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">tight_loop_contents</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">core1_resume</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">Pause_core1</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>   <span class="c1">//resume core1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>在写 Flash 之前用 <code>core1_stop()</code> 暂停核 1 的运行，写 Flash 之后用 <code>core1_resume()</code> 恢复核 1 的运行，即可安全地写 Flash。例如（例子修改自<a href="https://mkusunoki.net/?p=8196">这里</a>）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">pico_flash_prog</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lfs_config</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="kt">lfs_block_t</span> <span class="n">block</span><span class="p">,</span> <span class="kt">lfs_off_t</span> <span class="n">off</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">buffer</span><span class="p">,</span> <span class="kt">lfs_size_t</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">LFS_ASSERT</span><span class="p">(</span><span class="n">block</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">block_count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// program with SDK
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">core1_stop</span><span class="p">();</span>    <span class="c1">// stop core1 when writing to flash (read is OK)    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint32_t</span> <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">FS_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">block</span> <span class="o">*</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">off</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">ints</span> <span class="o">=</span> <span class="nf">save_and_disable_interrupts</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">flash_range_program</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">restore_interrupts</span><span class="p">(</span><span class="n">ints</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">core1_resume</span><span class="p">();</span>	<span class="c1">// resume core1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">LFS_ERR_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">pico_flash_erase</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lfs_config</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">lfs_block_t</span> <span class="n">block</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">LFS_ASSERT</span><span class="p">(</span><span class="n">block</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">block_count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// erase with SDK
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">core1_stop</span><span class="p">();</span>    <span class="c1">// stop core1 when writing to flash (read is OK)    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint32_t</span> <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">FS_BASE</span> <span class="o">+</span> <span class="n">block</span> <span class="o">*</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">ints</span> <span class="o">=</span> <span class="nf">save_and_disable_interrupts</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">flash_range_erase</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">restore_interrupts</span><span class="p">(</span><span class="n">ints</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">core1_resume</span><span class="p">();</span>	<span class="c1">//resume core1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">LFS_ERR_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></div>
    </article>
  </main>

      </div>
      <footer>
  <hr />
  
    <p id="social">
      Find me around the web:
      <br />
      
        
        <a href="mailto:bh1phl%20[at]%20hotmail.com">email</a>
      
         | 
        <a href="http://www.qrz.com/db/BH1PHL">qrz.com</a>
      
         | 
        <a href="https://qsl.net/bh1phl">qsl.net</a>
      
         | 
        <a href="https://bh1phl.github.io">github.io</a>
      
    </p>
  
  <p class="copyright">
    Copyright © 2014-2025
    <a href="/zh/"><strong>BH1PHL</strong></a>.
    Licensed under the
    <a href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> license unless otherwise noted.
  </p>
  <p class="builtWith">
    Built with
    <a href="http://www.gohugo.io/">Hugo</a>,
    using the theme
    <a href="https://gitlab.com/ian-s-mcb/smigle-hugo-theme">smigle</a>,
    which was influenced by the theme
    <a href="https://github.com/sumnerevans/smol">smol</a>.
  </p>
  <script>
    
    if (!(/(qsl.net)|(github.io)/.test(window.location.host)))
        window.goatcounter = {no_onload: true}
  </script>
  <script data-goatcounter="https://bh1phl.goatcounter.com/count"
    async src="https://qsl.net/bh1phl/count.js"></script>
</footer>

    </div>
  </body>
</html>
